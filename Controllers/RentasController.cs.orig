using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using VideoClub.Models;
using VideoClub.ViewModels;

namespace VideoClub.Controllers;

public class RentasController : Controller
{
    private readonly AppDbContext _context;

    public RentasController(AppDbContext context)
    {
        _context = context;
    }

    public async Task<IActionResult> Index()
    {
        try
        {
            var vm = new RentasViewModel
            {
                Rentas = await _context.Rentas
                    .Include(r => r.Empleado)
                    .Include(r => r.Articulo)
                    .Include(r => r.Cliente)
                    .OrderByDescending(r => r.NoRenta)
                    .ToListAsync(),
                Empleados = await _context.Empleados.Where(e => e.Estado == Empleados.EstadoEmpleados.Activo).ToListAsync(),
                Articulos = await _context.Articulos.Where(a => a.Estado == Articulos.EstadoArticulo.Disponible).ToListAsync(),
                Clientes = await _context.Clientes.Where(c => c.Estado == Clientes.EstadoCliente.Activo).ToListAsync()
            };

            ViewBag.Empleados = vm.Empleados;
            ViewBag.Articulos = vm.Articulos;
            ViewBag.Clientes = vm.Clientes;

            return View(vm);
        }
        catch (Exception ex)
        {
            Console.WriteLine("EF CORE ERROR: " + ex.ToString());
            throw;
        }
    }
    
    [HttpGet, Route("/api/Diag")]
    public IActionResult Diag()
    {
        var arts = _context.Articulos.Select(a => new { a.Id, a.Titulo, a.Estado }).ToList();
        return Ok(arts);
    }

    [HttpGet, Route("/api/TestDate")]
    public IActionResult TestDate()
    {
        try {
            var empId = _context.Empleados.FirstOrDefault()?.Id ?? 0;
            var cliId = _context.Clientes.FirstOrDefault()?.Id ?? 0;
            var artId = _context.Articulos.FirstOrDefault()?.Id ?? 0;

            if (empId == 0 || cliId == 0 || artId == 0) return BadRequest("Missing data in DB");

            var renta = new Renta
            {
                EmpleadoId = empId,
                ArticuloId = artId,
                ClienteId = cliId,
                FechaRenta = DateTime.UtcNow,
                FechaDevolucion = DateTime.UtcNow.AddDays(1),
                MontoPorDia = 10,
                CantidadDias = 1,
                Estado = Renta.EstadoRenta.Activa,
                Comentario = "Test"
            };
            _context.Rentas.Add(renta);
            _context.SaveChanges();
            return Ok("Success");
        } catch (Exception ex) {
            Console.WriteLine("TEST DATE ERROR: " + ex.ToString());
            return BadRequest(ex.ToString());
        }
    }

    [HttpPost]
    public IActionResult Create([FromBody] RentaCreationDto dto)
    {
        if (dto == null)
        {
            return BadRequest("Los datos enviados están vacíos o tienen un formato incorrecto.");
        }

        if (!ModelState.IsValid)
        {
            var errors = string.Join(", ", ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage));
            Console.WriteLine("MODEL STATE ERRORS: " + errors);
            return BadRequest($"Error de Validación: {errors}");
        }
            return BadRequest($"Error de Validación: {errors}");
        }

        try
        {
            var renta = new Renta
            {
                EmpleadoId = dto.EmpleadoId,
                ArticuloId = dto.ArticuloId,
                ClienteId = dto.ClienteId,
                FechaRenta = DateTime.SpecifyKind(dto.FechaRenta, DateTimeKind.Utc),
                FechaDevolucion = DateTime.SpecifyKind(dto.FechaDevolucion, DateTimeKind.Utc),
                MontoPorDia = dto.MontoPorDia,
                CantidadDias = dto.CantidadDias,
                Comentario = dto.Comentario,
                Estado = dto.Estado
            };

            // Update Article Status to Rentado
            var articulo = _context.Articulos.Find(dto.ArticuloId);
            if (articulo != null)
            {
                articulo.Estado = Articulos.EstadoArticulo.Rentado;
                _context.Articulos.Update(articulo);
            }

            _context.Rentas.Add(renta);
            _context.SaveChanges();

            return Ok();
        }
        catch (Exception ex)
        {
            var exceptionMsg = ex.InnerException?.Message ?? ex.Message;
            Console.WriteLine("DB EXCEPTION: " + exceptionMsg);
            return BadRequest($"Error Base de Datos: {exceptionMsg}. Datos Obtenidos: Emp={dto.EmpleadoId}, Cli={dto.ClienteId}, Art={dto.ArticuloId}, F1={dto.FechaRenta}, F2={dto.FechaDevolucion}, Monto={dto.MontoPorDia}");
        }
    }

    [HttpPut]
    public IActionResult Update([FromBody] RentaCreationDto dto)
    {
        if (dto == null)
        {
            return BadRequest("Los datos enviados están vacíos o tienen un formato incorrecto.");
        }

        if (!ModelState.IsValid) return BadRequest();

        var existing = _context.Rentas.Find(dto.NoRenta);
        if (existing == null) return NotFound();

        // If returned or changed article, handle article status logic here ideally.
        // For simplicity, we just update the Renta record.
        if (existing.ArticuloId != dto.ArticuloId)
        {
            // Set old article to available
            var oldArticulo = _context.Articulos.Find(existing.ArticuloId);
            if(oldArticulo != null){
                 oldArticulo.Estado = Articulos.EstadoArticulo.Disponible;
                _context.Articulos.Update(oldArticulo);
            }
           
            // Set new article to rentado
            var newArticulo = _context.Articulos.Find(dto.ArticuloId);
            if(newArticulo != null){
                newArticulo.Estado = Articulos.EstadoArticulo.Rentado;
                _context.Articulos.Update(newArticulo);
            }
        }

        if (dto.Estado == Renta.EstadoRenta.Devuelta || dto.Estado == Renta.EstadoRenta.Cancelada)
        {
             var articulo = _context.Articulos.Find(dto.ArticuloId);
             if (articulo != null)
             {
                 articulo.Estado = Articulos.EstadoArticulo.Disponible;
                 _context.Articulos.Update(articulo);
             }
        }

        existing.EmpleadoId = dto.EmpleadoId;
        existing.ArticuloId = dto.ArticuloId;
        existing.ClienteId = dto.ClienteId;
        existing.FechaRenta = DateTime.SpecifyKind(dto.FechaRenta, DateTimeKind.Utc);
        existing.FechaDevolucion = DateTime.SpecifyKind(dto.FechaDevolucion, DateTimeKind.Utc);
        existing.MontoPorDia = dto.MontoPorDia;
        existing.CantidadDias = dto.CantidadDias;
        existing.Comentario = dto.Comentario;
        existing.Estado = dto.Estado;

        _context.Rentas.Update(existing);
        _context.SaveChanges();

        return Ok(existing);
    }

    [HttpDelete]
    public IActionResult Delete([FromBody] int id)
    {
        var data = _context.Rentas.Find(id);
        if (data == null) return NotFound();

        // Optional: restore article status to available if needed
        var articulo = _context.Articulos.Find(data.ArticuloId);
        if (articulo != null && data.Estado != Renta.EstadoRenta.Devuelta)
        {
            articulo.Estado = Articulos.EstadoArticulo.Disponible;
            _context.Articulos.Update(articulo);
        }

        _context.Rentas.Remove(data);
        _context.SaveChanges();
        return Ok(data);
    }
}
